name: Cloudflare Workers Deploy (Main)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Production
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm ci

      - name: Set Production Environment
        run: |
          echo "Current branch is MAIN (Production)"
          # 本番用
          echo "DEPLOY_NAME=${{ vars.WORKERS_PROD_PROJECT_NAME }}" >> $GITHUB_ENV
          echo "API_BASE_URL=${{ vars.WORKERS_PROD_API_URL }}" >> $GITHUB_ENV
          echo "MEDIA_URL=${{ vars.WORKERS_PROD_MEDIA_URL }}" >> $GITHUB_ENV

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_BASE_URL: ${{ vars.WORKERS_PROD_API_URL }}
          NEXT_PUBLIC_MEDIA_URL: ${{ vars.WORKERS_PROD_MEDIA_URL }}

      - name: Generate wrangler.toml
        run: |
          TODAY=$(date +%Y-%m-%d)

          # 環境変数に入れた値を使用 (DEPLOY_NAME)
          echo "name = \"$DEPLOY_NAME\"" > wrangler.toml

          echo "compatibility_date = \"$TODAY\"" >> wrangler.toml
          echo "compatibility_flags = [\"nodejs_compat\"]" >> wrangler.toml

          echo "" >> wrangler.toml
          echo "[site]" >> wrangler.toml
          echo "bucket = \"./out\"" >> wrangler.toml

          echo "" >> wrangler.toml
          echo "[vars]" >> wrangler.toml

          # 環境変数に入れた値を使用
          echo "API_BASE_URL = \"$API_BASE_URL\"" >> wrangler.toml
          echo "MEDIA_URL = \"$MEDIA_URL\"" >> wrangler.toml

          # 確認用 (Secrets以外を表示)
          cat wrangler.toml

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}


